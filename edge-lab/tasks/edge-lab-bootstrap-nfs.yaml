---
Description: "A task to create an NFS share from the DRP server"
Name: "edge-lab-bootstrap-nfs"
Documentation: |
  Install NFS server and creates a share
  Primary usecase is to support shared storage for a k3s cluster
ExtraClaims:
  - scope: "subnets"
    action: "get"
    specific: "edge-lab"
Templates:
  - Name: "build_key_add_it"
    Path: ""
    Contents: |
      #!/usr/bin/env bash

      {{ template "setup.tmpl" . }}

      FAMILY=$(grep "^ID=" /etc/os-release | tr -d '"' | cut -d '=' -f 2)
      echo "FAMILY set from os-release to:  '$FAMILY'"

      case $FAMILY in
        redhat|centos) _pkgmgr="yum"; yum -y install epel-release ;;
        debian|ubuntu) _pkgmgr="apt" ;;
        *) >&2 echo "Unsupported package manager family '$FAMILY'."
           exit 1 ;;
      esac

      echo "starting NFS install"

      if systemctl is-active nfs-server.service ; then
        STATUS="$(systemctl is-active nfs-server.service && "inactive")"
        echo "NSF-Server status ${STATUS}...."
        case $STATUS in
          active) echo "NFS-Server already running, do not reinstall."
            systemctl stop nfs-server ;;
          failed) echo "NFS-Server in failed state - halting!"
            exit 1 ;;
          inactive) echo "install NFS-Server"
            $_pkgmgr -y install nfs-server;;
          *) echo "NFS-Server in $STATUS state - halting!"
            exit 1 ;;
        esac
      else
        echo "install NFS-Server (is-active failed)"
        $_pkgmgr -y install nfs-server
      fi
        
      if [[ -e "/export/shared" ]]; then
        echo "/export/shared file space exists, do not create"
      else
        echo "creating /export/shared"
        mkdir -p /export/shared
        chmod 777 /export/shared
      fi

      SUBNET=$(drpcli subnets show edge-lab | jq -r .Subnet)
      echo "creating shares for edge-lab subnet ${SUBNET}"
      tee /etc/exports >/dev/null << EOF
      /export        ${SUBNET}(rw,fsid=0,insecure,no_subtree_check,async)
      /export/shared ${SUBNET}(rw,nohide,insecure,no_subtree_check,async)
      EOF

      systemctl enable nfs-server
      systemctl start nfs-server
      systemctl status nfs-server

      exit 1
Meta:
  icon: "file text"
  color: "yellow"
  title: "Community Content"
  feature-flags: "sane-exit-codes"
  copyright: "RackN 2020"
