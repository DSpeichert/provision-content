#!/usr/local/bin/env bash
# Cluster Add-Step-Remove-Sync Common Code
#
###
#  This is a BASH script snippet intended to be run inside other BASH templates.
#  It assumed you are also running setup.tmpl
#
#
#  To use this in other templates, simply specify:
#
#         \{\{template "cluster-shared.tmpl" .\}\}
#
#  without the backslashes.
###

CLUSTER_PROFILE={{.Param "cluster/profile"}}

echo "=== CLUSTER SHARED CODE START ==="

echo "Assign $CLUSTER_PROFILE Profile to Machine if missing"
{{ $profiles := .Machine.Profiles }}
{{ $profile := .Param "cluster/profile" }}
{{ if has $profile $profiles }}
  echo "No Action: Profile $CLUSTER_PROFILE already assigned to Machine $RS_UUID"
{{ else }}
  echo "Verifying Cluster Profile $CLUSTER_PROFILE Exists (create if missing)"
  if drpcli profiles exists $CLUSTER_PROFILE; then
    echo "No Action: Profile $CLUSTER_PROFILE exists"
  else
    echo "Creating $CLUSTER_PROFILE (requires Task to have ExtraClaims for Profiles)"
    drpcli profiles create '{
      "Name":"{{.Param "cluster/profile"}}",
      "Description": "Cluster Tracking (added automatically)",
      "Params":{"cluster/profile":"{{.Param "cluster/profile"}}"},
      "Meta":{"icon":"object group outline", "color": "green"},
    }'
  fi
  echo "Verifying Cluster Profile has Param cluster/profile = $CLUSTER_PROFILE (add if missing)"
  if [[ "$(drpcli profiles get $CLUSTER_PROFILE param cluster/profile)" == "{{.Param "cluster/profile"}}" ]]; then
    echo "No Action: Profile $CLUSTER_PROFILE Param cluster/profile set correctly."
  else
    echo "Setting Param[cluster/profile] in $CLUSTER_PROFILE"
    drpcli profiles set $CLUSTER_PROFILE param cluster/profile to "$CLUSTER_PROFILE"
  fi
  echo "Adding $CLUSTER_PROFILE to Machine $RS_UUID"
  drpcli machines addprofile $RS_UUID $CLUSTER_PROFILE | jq .Profiles
{{ end }}

PROFILE_TOKEN={{.GenerateProfileToken (.Param "cluster/profile") 7200}}

CLUSTER_LEADERS="{{ .ParamAsJSON "cluster/leaders" }}"
CLUSTER_I_AM_LEADER=false
{{range $index, $leader := .Param "cluster/leaders"}}
  if [[ "$RS_UUID" == "{{$leader.Uuid}}" ]]; then
    echo "I am leader {{$index}}!"
    CLUSTER_I_AM_LEADER=true
  fi
{{else}}
  echo "No Leaders Assigned - make sure cluster-setup is run if needed"
{{end}}

echo "=== CLUSTER SHARED CODE END ==="
